define("tc.mainModule",[],function(){"use strict";var e=angular.module("tfcalculator.tc",[]);return console.log("angular.module: tfcalculator.tc created."),e}),define("tcService",["tc.mainModule"],function(e){"use strict";var t=function(){return{dto:{changeFuture:{futureInitRequestDto:{targetBonds:"selectedBondType.value",futureContract:{tfId:"selectedFuture.tfId",tradingDate:"selectedFuture.startDate",deliveryDate:"selectedFuture.maturityDate"},capitalCost:"capitalCost",bondPrice:{"yield":"selectedBond.yield",netPrice:"selectedBond.netPrice",fullPrice:"selectedBond.fullPrice",yieldType:"selectedYieldType.value",lastBondUpdateDate:"selectedBond.lastBondUpdateDate"},bondInfo:{bondKey:"selectedBond.bondKey",listedMarket:"selectedBond.listedMarket",fixedCoupon:"selectedBond.fixedCoupon",paymentFrequency:"selectedBond.paymentFrequency.value",interestStartDate:"selectedBond.interestStartDate",maturityDate:"selectedBond.maturityDate"},calculationMainRequest:{calculationType:"selectedCalTgtType.value"}}},changeFuture_bondPrice:{BPMainRequestDto:{futurePrice:"selectedFuture.futurePrice",irr:"calculationResult.calculationMainResult.irr",basis:"calculationResult.calculationMainResult.basis",netBasis:"calculationResult.calculationMainResult.netBasis"}},changeFuture_futureAnalysis:{FSAMainRequestDto:{irr:"calculationResult.calculationMainResult.irr",basis:"calculationResult.calculationMainResult.basis",netBasis:"calculationResult.calculationMainResult.netBasis"}},doCalCulate:{calculationRequestDto:{futureContract:{tfId:"selectedFuture.tfId",tradingDate:"selectedFuture.startDate",deliveryDate:"selectedFuture.maturityDate"},capitalCost:"capitalCost",bondPrice:{"yield":"selectedBond.yield",netPrice:"selectedBond.netPrice",fullPrice:"selectedBond.fullPrice",yieldType:"selectedYieldType.value",lastBondUpdateDate:"selectedBond.lastBondUpdateDate"},bondPriceType:"selectedBond.bondPriceType",bondInfo:{bondKey:"selectedBond.bondKey",listedMarket:"selectedBond.listedMarket",fixedCoupon:"selectedBond.fixedCoupon",paymentFrequency:"selectedBond.paymentFrequency.value",interestStartDate:"selectedBond.interestStartDate",maturityDate:"selectedBond.maturityDate"},calculationMainRequest:{calculationType:"selectedCalTgtType.value"}},IRRMainRequestDto:{futurePrice:"selectedFuture.futurePrice"}},doCalCulate_bondPrice:{BPMainRequestDto:{futurePrice:"selectedFuture.futurePrice",irr:"calculationResult.calculationMainResult.irr",basis:"calculationResult.calculationMainResult.basis",netBasis:"calculationResult.calculationMainResult.netBasis"}},doCalCulate_futureAnalysis:{FSAMainRequestDto:{irr:"calculationResult.calculationMainResult.irr",basis:"calculationResult.calculationMainResult.basis",netBasis:"calculationResult.calculationMainResult.netBasis"}},cal:{calculationRequestDto:{},capitalCost:2.5,bondInfo:{listedMarket:"CIB",fixedCoupon:2.55,interestStartDate:"2016-04-28",maturityDate:"2019-04-28",paymentFrequency:"A"},calculationMainRequest:{calculationType:"IRR_BASE"},IRRMainRequestDto:{futurePrice:100}},bondInfo_scheduledBonds:{bondCode:"selectedBond.id",fixedCoupon:"selectedBond.fixedCoupon",paymentFrequency:"selectedBond.paymentFrequency.value",interestStartDate:"selectedBond.interestStartDate",maturityDate:"selectedBond.maturityDate"},bondInfo_virtualBond:{listedMarket:"selectedBond.listedMarket",fixedCoupon:"selectedBond.fixedCoupon",paymentFrequency:"selectedBond.paymentFrequency.value",interestStartDate:"selectedBond.interestStartDate",maturityDate:"selectedBond.maturityDate"}}}}();e.service("tcService",["$location","$filter","servicePathConst","httpService","commonService",function(e,a,n,o,l){var r=a("filetimeToDatetime");this.updateViewModel=function(e,t){if(e&&t)for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])},this.changeFuture=function(e,a,i){if(!e.vm||!e.vm.selectedFuture)return void(i&&i());e.vm.selectedBond||(e.vm.selectedBond=angular.copy(e.originVM.selectedBond)),e.vm.calculationResult&&e.vm.calculationResult.exception&&(delete e.vm.calculationResult.exception,e.vm.calculationResult=angular.copy(e.originVM.calculationResult)),e.vm.calculationResult.calculationMainResult||(e.vm.calculationResult.calculationMainResult={}),e.vm.calculationResult.calculationMainResult.irr||(e.vm.calculationResult.calculationMainResult.irr=1);var c=l.getDto(e.vm,t.dto.changeFuture,e.DATE_FORMAT);e.vm&&e.vm.selectedCalTgtType&&(e.vm.selectedCalTgtType.value===e.calTgtTypeButtons[1].value?angular.merge(c,l.getDto(e.vm,t.dto.changeFuture_bondPrice,e.DATE_FORMAT)):e.vm.selectedCalTgtType.value!==e.calTgtTypeButtons[2].value&&e.vm.selectedCalTgtType.value!==e.calTgtTypeButtons[3].value||(angular.merge(c,l.getDto(e.vm,t.dto.changeFuture_futureAnalysis,e.DATE_FORMAT)),delete c.IRRMainRequestDto)),o.postService(n.tc_post_future_init,c,function(t){function n(t,a){var n=void 0;t.paymentFrequency&&(n=e.paymentFrequencys.findItem(function(e){return e.value===t.paymentFrequency}),n&&(t.paymentFrequency=n)),t.couponType&&(n=e.paymentFrequencys.findItem(function(e){return e.value===t.couponType}),n&&(t.paymentFrequency=n)),e.vm.calculationResult.bondConvertionFactors&&e.vm.calculationResult.bondConvertionFactors.length>0&&e.vm.calculationResult.bondConvertionFactors instanceof Array&&(n=e.vm.calculationResult.bondConvertionFactors.findItem(function(e){return e.bondKey===t.bondKey}),n&&(t.convertionFactor=n.convertionFactor),n=e.vm.calculationResult.bondConvertionFactors.findItem(function(e){return e.bondKey===t.id}),n&&(t.convertionFactor=n.convertionFactor)),(t.couponRate||0===t.couponRate)&&(t.fixedCoupon=t.couponRate),t.tradeDate&&(t.interestStartDate=r(t.tradeDate)),t.settlementDate&&(t.maturityDate=r(t.settlementDate)),t.issueStartDate&&(t.issueStartDate=r(t.issueStartDate))}function o(a){a&&a.length>0&&a instanceof Array&&(a.forEach(n),e.vm.calculationResult.deliverableBonds=a,e.vm.selectedBond=e.vm.calculationResult.deliverableBonds[0],angular.merge(e.vm.selectedBond,e.vm.calculationResult.defaultBondPrice),angular.merge(e.vm.selectedBond,t.calculationMainResult))}if(!t)return l.commonErrorDialog(e,void 0,"没有获取到所选债券数据"),void(i&&i());e.vm.calculationResult||(e.vm.calculationResult={}),angular.merge(e.vm.calculationResult,t),e.vm.calculationResult.deliverableBonds=void 0;var c=l.getPropertyX(t,"defaultBondPrice.yieldType");c&&(e.vm.selectedYieldType=e.yieldTypeButtons.findItem(function(e){return e.value===c})),o(e.vm.calculationResult.selectableBonds),o(e.vm.calculationResult.scheduledBondInfos),angular.merge(e.vm.selectedFuture,e.vm.calculationResult.futruePrice),t.exception?l.commonErrorDialog(e,void 0,"收益率为空，请数量输入收益率再参与计算"):e.originVM=angular.copy(e.vm),t.defaultBondPrice||e.vm.selectedCalTgtType&&"BOND_PRICE"===e.vm.selectedCalTgtType.value||l.commonErrorDialog(e,void 0,"数据库错误。 ofr、bid、成交、中债估值都为空。请手动输入债券收益率。"),a&&a()},function(t){t&&t.return_message&&"E1001"===t.return_message.exceptionCode?(t.return_message.exceptionCode="提示",t.return_message.exceptionName="",t.return_message.exceptionMessage="",l.commonErrorDialog(e,t,"该合约无对应期限的 “未发国债” ， 请切换到 “可交割券”。")):l.commonErrorDialog(e,t,"获取所选债券数据失败"),i&&i()})},this.doCalCulate=function(e,a,r){if(e.vm){if(e.vm.calculationResult||(e.vm.calculationResult=angular.copy(e.originVM.calculationResult)),!e.vm.selectedBond)return l.commonErrorDialog(e,void 0,"债券信息不能为空"),void(r&&r());var i=l.getDto(e.vm,t.dto.doCalCulate,e.DATE_FORMAT);e.vm.selectedCalTgtType&&(e.vm.selectedCalTgtType.value===e.calTgtTypeButtons[1].value?angular.merge(i,l.getDto(e.vm,t.dto.doCalCulate_bondPrice,e.DATE_FORMAT)):e.vm.selectedCalTgtType.value!==e.calTgtTypeButtons[2].value&&e.vm.selectedCalTgtType.value!==e.calTgtTypeButtons[3].value||(angular.merge(i,l.getDto(e.vm,t.dto.doCalCulate_futureAnalysis,e.DATE_FORMAT)),delete i.IRRMainRequestDto)),e.vm.selectedBondType&&(e.vm.selectedBondType.value===e.bondTypeButtons[1].value?i.calculationRequestDto.bondInfo=l.getDto(e.vm,t.dto.bondInfo_scheduledBonds,e.DATE_FORMAT):e.vm.selectedBondType.value===e.bondTypeButtons[3].value&&(i.calculationRequestDto.bondInfo=l.getDto(e.vm,t.dto.bondInfo_virtualBond,e.DATE_FORMAT))),o.postService(n.tc_post_do_calculation,i,function(t){if(!t)return r&&r(),void l.commonErrorDialog(e,void 0,"计算失败");angular.merge(e.vm.calculationResult,t),angular.merge(e.vm.selectedBond,t.bondPrice),t.calculationMainResult&&angular.merge(e.vm.selectedBond,t.calculationMainResult),t.bondConvertionFactor&&(e.vm.selectedBond.convertionFactor=t.bondConvertionFactor);var n=l.getPropertyX(t,"calculationMainResult.futurePrice");n&&l.setPropertyX(e,"vm.selectedFuture.futurePrice",n),a&&a()},function(t){l.commonErrorDialog(e,t,"计算失败"),r&&r()})}}}])}),function(e,t){"object"==typeof module&&module.exports?module.exports=t():"function"==typeof define&&define.amd?define("spin",[],t):e.Spinner=t()}(this,function(){"use strict";function e(e,t){var a,n=document.createElement(e||"div");for(a in t)n[a]=t[a];return n}function t(e){for(var t=1,a=arguments.length;t<a;t++)e.appendChild(arguments[t]);return e}function a(e,t,a,n){var o=["opacity",t,~~(100*e),a,n].join("-"),l=.01+a/n*100,r=Math.max(1-(1-e)/t*(100-l),e),i=u.substring(0,u.indexOf("Animation")).toLowerCase(),c=i&&"-"+i+"-"||"";return m[o]||(s.insertRule("@"+c+"keyframes "+o+"{0%{opacity:"+r+"}"+l+"%{opacity:"+e+"}"+(l+.01)+"%{opacity:1}"+(l+t)%100+"%{opacity:"+e+"}100%{opacity:"+r+"}}",s.cssRules.length),m[o]=1),o}function n(e,t){var a,n,o=e.style;if(t=t.charAt(0).toUpperCase()+t.slice(1),void 0!==o[t])return t;for(n=0;n<d.length;n++)if(a=d[n]+t,void 0!==o[a])return a}function o(e,t){for(var a in t)e.style[n(e,a)||a]=t[a];return e}function l(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)void 0===e[n]&&(e[n]=a[n])}return e}function r(e,t){return"string"==typeof e?e:e[t%e.length]}function i(e){this.opts=l(e||{},i.defaults,v)}function c(){function a(t,a){return e("<"+t+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',a)}s.addRule(".spin-vml","behavior:url(#default#VML)"),i.prototype.lines=function(e,n){function l(){return o(a("group",{coordsize:s+" "+s,coordorigin:-u+" "+-u}),{width:s,height:s})}function i(e,i,c){t(m,t(o(l(),{rotation:360/n.lines*e+"deg",left:~~i}),t(o(a("roundrect",{arcsize:n.corners}),{width:u,height:n.scale*n.width,left:n.scale*n.radius,top:-n.scale*n.width>>1,filter:c}),a("fill",{color:r(n.color,e),opacity:n.opacity}),a("stroke",{opacity:0}))))}var c,u=n.scale*(n.length+n.width),s=2*n.scale*u,d=-(n.width+n.length)*n.scale*2+"px",m=o(l(),{position:"absolute",top:d,left:d});if(n.shadow)for(c=1;c<=n.lines;c++)i(c,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(c=1;c<=n.lines;c++)i(c);return t(e,m)},i.prototype.opacity=function(e,t,a,n){var o=e.firstChild;n=n.shadow&&n.lines||0,o&&t+n<o.childNodes.length&&(o=o.childNodes[t+n],o=o&&o.firstChild,o=o&&o.firstChild,o&&(o.opacity=a))}}var u,s,d=["webkit","Moz","ms","O"],m={},v={lines:12,length:7,width:5,radius:10,scale:1,corners:1,color:"#000",opacity:.25,rotate:0,direction:1,speed:1,trail:100,fps:20,zIndex:2e9,className:"spinner",top:"50%",left:"50%",shadow:!1,hwaccel:!1,position:"absolute"};if(i.defaults={},l(i.prototype,{spin:function(t){this.stop();var a=this,n=a.opts,l=a.el=e(null,{className:n.className});if(o(l,{position:n.position,width:0,zIndex:n.zIndex,left:n.left,top:n.top}),t&&t.insertBefore(l,t.firstChild||null),l.setAttribute("role","progressbar"),a.lines(l,a.opts),!u){var r,i=0,c=(n.lines-1)*(1-n.direction)/2,s=n.fps,d=s/n.speed,m=(1-n.opacity)/(d*n.trail/100),v=d/n.lines;!function p(){i++;for(var e=0;e<n.lines;e++)r=Math.max(1-(i+(n.lines-e)*v)%d*m,n.opacity),a.opacity(l,e*n.direction+c,r,n);a.timeout=a.el&&setTimeout(p,~~(1e3/s))}()}return a},stop:function(){var e=this.el;return e&&(clearTimeout(this.timeout),e.parentNode&&e.parentNode.removeChild(e),this.el=void 0),this},lines:function(n,l){function i(t,a){return o(e(),{position:"absolute",width:l.scale*(l.length+l.width)+"px",height:l.scale*l.width+"px",background:t,boxShadow:a,transformOrigin:"left",transform:"rotate("+~~(360/l.lines*s+l.rotate)+"deg) translate("+l.scale*l.radius+"px,0)",borderRadius:(l.corners*l.scale*l.width>>1)+"px"})}for(var c,s=0,d=(l.lines-1)*(1-l.direction)/2;s<l.lines;s++)c=o(e(),{position:"absolute",top:1+~(l.scale*l.width/2)+"px",transform:l.hwaccel?"translate3d(0,0,0)":"",opacity:l.opacity,animation:u&&a(l.opacity,l.trail,d+s*l.direction,l.lines)+" "+1/l.speed+"s linear infinite"}),l.shadow&&t(c,o(i("#000","0 0 4px #000"),{top:"2px"})),t(n,t(c,i(r(l.color,s),"0 0 1px rgba(0,0,0,.1)")));return n},opacity:function(e,t,a){t<e.childNodes.length&&(e.childNodes[t].style.opacity=a)}}),"undefined"!=typeof document){s=function(){var a=e("style",{type:"text/css"});return t(document.getElementsByTagName("head")[0],a),a.sheet||a.styleSheet}();var p=o(e("group"),{behavior:"url(#default#VML)"});!n(p,"transform")&&p.adj?c():u=n(p,"animation")}return i}),define("tc.mainCtrl",["tc.mainModule","spin"],function(e,t){"use strict";var a="yyyy-MM-dd",n="yyyy-MM-dd HH:mm:ss",o=function(){return{bondTypeButtons:[{value:"DELIVABLE_BONDS",display:"可交割券"},{value:"SCHEDULED_BONDS",display:"未发国债"},{value:"SELECTED_BOND",display:"自选券"},{value:"VIRTUAL_BOND",display:"虚拟券"}],calTgtTypeButtons:[{value:"IRR_BASE",display:"IRR/基差",viewUrl:"tf_calculator/views/tabView.html"},{value:"BOND_PRICE",display:"债券价格",viewUrl:"tf_calculator/views/tabView_bondPrice.html"},{value:"FUTURE_ANALYSIS",display:"期货情景分析",viewUrl:"tf_calculator/views/tabView_futureAnalysis.html"},{value:"FUTURE_THEORETICAL_PRICE",display:"期货理论价格",viewUrl:"tf_calculator/views/tabView_futureTheoreticalPrice.html"}],yieldTypeButtons:[{value:"ofr",display:"Ofr"},{value:"bid",display:"Bid"},{value:"deal",display:"成交"},{value:"cdc",display:"中债"}],paymentFrequencys:[{value:"S",display:"半年度"},{value:"A",display:"年度"}],dayCounts:[{value:"BA0",display:"360日"},{value:"BAA",display:"当前年"},{value:"BA5",display:"365日"},{value:"B30",display:"360日"}],bondPriceType:{"vm.selectedBond.yield":"YIELD","vm.selectedBond.netPrice":"NET_PRICE","vm.selectedBond.fullPrice":"FULL_PRICE"},vaildRule:{doCalculation_IRR_BASE:[{prop:"vm.selectedBond.interestStartDate",displayName:"起息日"},{prop:"vm.selectedBond.maturityDate",displayName:"到期日"},{prop:"vm.selectedBond.paymentFrequency",displayName:"付息频率"},{prop:"vm.selectedBond.fixedCoupon",displayName:"票息率"},{prop:["vm.selectedBond.yield","vm.selectedBond.netPrice","vm.selectedBond.fullPrice"],displayName:'"收益率" 或 "债券净价" 或 "债券全价"'}],doCalculation_BOND_PRICE:[{prop:"vm.selectedBond.interestStartDate",displayName:"起息日"},{prop:"vm.selectedBond.maturityDate",displayName:"到期日"},{prop:"vm.selectedBond.paymentFrequency",displayName:"付息频率"},{prop:"vm.selectedBond.fixedCoupon",displayName:"票息率"}],doCalculation_FUTURE_ANALYSIS:[{prop:"vm.selectedBond.interestStartDate",displayName:"起息日"},{prop:"vm.selectedBond.maturityDate",displayName:"到期日"},{prop:"vm.selectedBond.paymentFrequency",displayName:"付息频率"},{prop:"vm.selectedBond.fixedCoupon",displayName:"票息率"},{prop:["vm.selectedBond.yield","vm.selectedBond.netPrice","vm.selectedBond.fullPrice"],displayName:'"收益率" 或 "债券净价" 或 "债券全价"'}],doCalculation_common:[{prop:"vm.selectedFuture.futurePrice",displayName:"期货价格",errMessage:"期货价格输入错误，小数位最多3位，最大值1000，最小值0",pattern:/^(\d{0,4})$|^(\d{0,4}.\d{1,3})$/,max:1e3,min:0},{prop:"vm.selectedFuture.yield",displayName:"收益率",errMessage:"收益率输入错误，正确格式： 00.0000, 最大值100%，最小值-100%",pattern:/^(-?\d{0,2})$|^(-?\d{0,2}.\d{1,4})$/,max:100,min:-100},{prop:"vm.selectedFuture.netPrice",displayName:"债券净价",errMessage:"债券净价输入错误，小数位最多4位，最大值1000，最小值0",pattern:/^(\d{0,4})$|^(\d{0,4}.\d{1,4})$/,max:1e3,min:0},{prop:"vm.selectedFuture.fullPrice",displayName:"债券全价",errMessage:"债券全价输入错误，小数位最多4位，最大值1000，最小值0",pattern:/^(\d{0,4})$|^(\d{0,4}.\d{1,4})$/,max:1e3,min:0},{prop:"vm.capitalCost",displayName:"资金成本",errMessage:"资金成本输入错误，小数位最多3位，最大值100%，最小值0%",pattern:/^(\d{0,3})$|^(\d{0,3}.\d{1,3})$/,max:100,min:0},{prop:"vm.selectedBond.fixedCoupon",displayName:"票息率",errMessage:"票息率输入错误，正确格式： 00.0000, 最大值100%，最小值0%",pattern:/^(\d{0,4})$|^(\d{0,4}.\d{1,4})$/,max:100,min:0},{prop:"vm.selectedBond.yield",displayName:"收益率",errMessage:"收益率输入错误，正确格式： 00.0000, 最大值100%，最小值-100%",pattern:/^(-?\d{0,2})$|^(-?\d{0,2}.\d{1,4})$/,max:100,min:-100},{prop:"vm.selectedBond.irr",displayName:"IRR",errMessage:"IRR输入错误，小数位最多4位，最大值100%，最小值-100%",pattern:/^(-?\d{0,3})$|^(-?\d{0,3}.\d{1,4})$/,max:100,min:-100},{prop:"vm.selectedBond.basis",displayName:"基差",errMessage:"基差输入错误，小数位最多4位，最大值100，最小值-100",pattern:/^(-?\d{0,3})$|^(-?\d{0,3}.\d{1,4})$/,max:100,min:-100},{prop:"vm.selectedBond.netBasis",displayName:"净基差",errMessage:"净基差输入错误，小数位最多4位，最大值100，最小值-100",pattern:/^(-?\d{0,3})$|^(-?\d{0,3}.\d{1,4})$/,max:100,min:-100},{prop:"vm.calculationResult.calculationMainResult.irr",displayName:"IRR",errMessage:"IRR输入错误，小数位最多4位，最大值100%，最小值-100%",pattern:/^(-?\d{0,3})$|^(-?\d{0,3}.\d{1,4})$/,max:100,min:-100},{prop:"vm.calculationResult.calculationMainResult.basis",displayName:"基差",errMessage:"基差输入错误，小数位最多4位，最大值100，最小值-100",pattern:/^(-?\d{0,3})$|^(-?\d{0,3}.\d{1,4})$/,max:100,min:-100},{prop:"vm.calculationResult.calculationMainResult.netBasis",displayName:"净基差",errMessage:"净基差输入错误，小数位最多4位，最大值100，最小值-100",pattern:/^(-?\d{0,3})$|^(-?\d{0,3}.\d{1,4})$/,max:100,min:-100}],ruleList:[{indexList:[[0,-1],[1,-1]],prop:"vm.selectedFuture.futurePrice",displayName:"期货价格",errMessage:"期货价格输入错误，小数位最多3位，最大值1000，最小值0",pattern:/^(\d{0,4})$|^(\d{0,4}.\d{1,3})$/,max:1e3,min:0},{indexList:[[-1,1],[-1,3],[3,-1]],prop:"vm.selectedBond.fixedCoupon",displayName:"票息率",errMessage:"票息率输入错误，正确格式： 00.0000, 最大值100%，最小值0%",pattern:/^(\d{0,4})$|^(\d{0,4}.\d{1,4})$/,max:100,min:0},{indexList:[[0,-1],[1,-1],[2,3],[3,-1]],prop:"vm.capitalCost",displayName:"资金成本",errMessage:"资金成本输入错误，小数位最多3位，最大值100%，最小值0%",pattern:/^(\d{0,3})$|^(\d{0,3}.\d{1,3})$/,max:100,min:0},{indexList:[[0,-1],[2,3],[3,-1]],prop:"vm.selectedBond.yield",displayName:"收益率",errMessage:"收益率输入错误，正确格式： 00.0000, 最大值100%，最小值-100%",pattern:/^(-?\d{0,2})$|^(-?\d{0,2}.\d{1,4})$/,max:100,min:-100},{indexList:[[0,-1],[2,3],[3,-1]],prop:"vm.selectedBond.netPrice",displayName:"债券净价",errMessage:"债券净价输入错误，小数位最多4位，最大值1000，最小值0",pattern:/^(\d{0,4})$|^(\d{0,4}.\d{1,4})$/,max:1e3,min:0},{indexList:[[0,-1],[2,3],[3,-1]],prop:"vm.selectedBond.fullPrice",displayName:"债券全价",errMessage:"债券全价输入错误，小数位最多4位，最大值1000，最小值0",pattern:/^(\d{0,4})$|^(\d{0,4}.\d{1,4})$/,max:1e3,min:0},{indexList:[[1,-1],[2,3]],prop:"vm.calculationResult.calculationMainResult.irr",displayName:"IRR",errMessage:"IRR输入错误，小数位最多4位，最大值100%，最小值-100%",pattern:/^(-?\d{0,3})$|^(-?\d{0,3}.\d{1,4})$/,max:100,min:-100},{indexList:[[1,-1],[2,3]],prop:"vm.calculationResult.calculationMainResult.basis",displayName:"基差",errMessage:"基差输入错误，小数位最多4位，最大值100，最小值-100",pattern:/^(-?\d{0,3})$|^(-?\d{0,3}.\d{1,4})$/,max:100,min:-100},{indexList:[[1,-1],[2,3]],prop:"vm.calculationResult.calculationMainResult.netBasis",displayName:"净基差",errMessage:"净基差输入错误，小数位最多4位，最大值100，最小值-100",pattern:/^(-?\d{0,3})$|^(-?\d{0,3}.\d{1,4})$/,max:100,min:-100}]},dto:{changeBondYieldType:{GetYieldRequestDto:{calculationMainRequest:{calculationType:"selectedCalTgtType.value"},yieldType:"selectedYieldType.value",futureContract:{tfId:"selectedFuture.tfId",tradingDate:"selectedFuture.startDate",deliveryDate:"selectedFuture.maturityDate"},futurePrice:"selectedFuture.futurePrice",capitalCost:"capitalCost",bondKey:"selectedBond.bondKey",bondListedMarket:"selectedBond.listedMarket"},MainRequestDto:{irr:"calculationResult.calculationMainResult.irr"}}}}}();e.controller("tc.mainCtrl",["$scope","$state","$sce","$location","$filter","httpService","commonService","delayEventService","tcService","routeConst","servicePathConst",function(e,l,r,i,c,u,s,d,m,v,p){function y(){u.postService(p.tc_post_init_tfcalculator,void 0,function(t){return e.viewBusy(!1),t?(e.futures=t.futures,e.repoRates=t.repoRates,e.vm.calculationResult=t.calculationResult,e.vm.calculationResult&&e.vm.calculationResult.deliverableBonds&&e.vm.calculationResult.deliverableBonds.length>0&&e.vm.calculationResult.deliverableBonds instanceof Array&&(e.vm.calculationResult.deliverableBonds.forEach(function(t,a){var n=e.paymentFrequencys.findItem(function(e){return e.value===t.paymentFrequency});n&&(t.paymentFrequency=n),e.vm.calculationResult.bondConvertionFactor&&e.vm.calculationResult.bondConvertionFactor.length>0&&e.vm.calculationResult.bondConvertionFactor instanceof Array&&(n=e.vm.calculationResult.bondConvertionFactor.findItem(function(e){return e.bondKey===t.bondKey}),n&&(t.convertionFactor=n.convertionFactor))}),angular.merge(e.vm.calculationResult.deliverableBonds[0],e.vm.calculationResult.defaultBondPrice),e.vm.selectedBond=e.vm.calculationResult.deliverableBonds[0],e.vm.selectedYieldType=e.yieldTypeButtons.findItem(function(t){return t.value===e.vm.selectedBond.yieldType}),e.vm.calculationResult.defaultFuturePrice&&e.futures&&e.futures[0]&&angular.merge(e.futures[0],e.vm.calculationResult.defaultFuturePrice)),e.futures&&e.futures.length>0&&e.futures instanceof Array&&e.futures.forEach(function(e,t){e.maturityDate=h(e.maturityDate),e.startDate=h(e.startDate),console.debug(e)}),e.originFutures=angular.copy(e.futures),f(),void(e.originVM=angular.copy(e.vm))):void s.commonErrorDialog(e,void 0,"没有获取到初始化数据")},function(t){s.commonErrorDialog(e,t,"获取初始化数据失败"),e.viewBusy(!1)})}function f(){e.vm.selectedCalTgtType=o.calTgtTypeButtons[0],e.bondTypeButtons&&(e.vm.selectedBondType=e.bondTypeButtons[0]),e.futures&&(e.vm.selectedFuture=e.futures[0]),e.vm.capitalCost=0}function B(){if(!e.vm.selectedBond)return void s.commonErrorDialog(e,void 0,"债券信息不能为空");var t=s.getDto(e.vm,o.dto.changeBondYieldType,e.DATE_FORMAT);e.viewBusy(!0),u.postService(p.tc_post_do_change_bond_yield_type,t,function(t){if(e.viewBusy(!1),!t)return void s.commonErrorDialog(e,t,"获取所选债券数据失败");var a=s.getPropertyX(t,"calculationMainResult.futurePrice");a&&s.setPropertyX(e,"vm.selectedFuture.futurePrice",a),angular.merge(e.vm.calculationResult,t),angular.merge(e.vm.selectedBond,t.bondPrice)},function(t){s.commonErrorDialog(e,t,"获取所选债券数据失败"),e.viewBusy(!1)})}function g(t){if(!(t&&0!==t.length&&t instanceof Array))return!0;var a=!0;return t.forEach(function(t,n){if(a){var o=s.getPropertyX(e,t.prop);o&&(t.pattern&&!t.pattern.test(o)&&(s.commonErrorDialog(e,void 0,t.errMessage),a=!1),(t.max||0===t.max)&&t.max<=+o&&(s.commonErrorDialog(e,void 0,t.errMessage),a=!1),(t.min||0===t.min)&&t.min>=+o&&(s.commonErrorDialog(e,void 0,t.errMessage),a=!1))}}),a}function R(){e.viewBusy(!0),m.changeFuture(e,function(){e.viewBusy(!1)},function(){e.viewBusy(!1)})}function D(t){if(!e.vm.selectedCalTgtType)return!1;var a=s.getPropertyX(e,"vm.selectedFuture.startDate"),n=s.getPropertyX(e,"vm.selectedFuture.maturityDate");if(a&&n&&(a=new Date(a),n=new Date(n),a>=n))return s.commonErrorDialog(e,void 0,"交割日须晚于交易日，请重新输入。"),n.setDate(a.getDate()+1),s.setPropertyX(e,"vm.selectedBond.maturityDate",n),!1;var l=s.getPropertyX(e,"vm.selectedBond.interestStartDate");if(n=s.getPropertyX(e,"vm.selectedBond.maturityDate"),l&&n&&(l=new Date(l),n=new Date(n),l>n&&(n.setDate(l.getDate()+1),s.setPropertyX(e,"vm.selectedBond.maturityDate",n))),e.vm.selectedBondType&&"VIRTUAL_BOND"===e.vm.selectedBondType.value){var r="请输入计算所需的虚拟券信息。{0}";if(!e.vm||!e.vm.selectedBond)return s.commonErrorDialog(e,void 0,r.format("")),!1;if(!o.vaildRule.hasOwnProperty("doCalculation_"+e.vm.selectedCalTgtType.value))return!0;var i=o.vaildRule["doCalculation_"+e.vm.selectedCalTgtType.value],c=i.findWhere(function(t){if(t.prop instanceof Array){var a=!0;return t.prop.forEach(function(t,n){var o=s.getPropertyX(e,t);(o||0===o)&&(a=!1)}),a}var n=s.getPropertyX(e,t.prop);return 0!==n&&!s.getPropertyX(e,t.prop)}).map(function(e){return e.displayName}).join(",");if(c.length>0)return"vm.selectedBond.interestStartDate"!==t&&"vm.selectedBond.maturityDate"!==t&&"vm.selectedBond.paymentFrequency"!==t&&s.commonErrorDialog(e,void 0,r.format("\r\n"+c)),!1}switch(t){case"vm.calculationResult.calculationMainResult.irr":s.setPropertyX(e,"vm.calculationResult.calculationMainResult.basis",void 0),s.setPropertyX(e,"vm.calculationResult.calculationMainResult.netBasis",void 0);break;case"vm.calculationResult.calculationMainResult.basis":s.setPropertyX(e,"vm.calculationResult.calculationMainResult.irr",void 0),s.setPropertyX(e,"vm.calculationResult.calculationMainResult.netBasis",void 0);break;case"vm.calculationResult.calculationMainResult.netBasis":s.setPropertyX(e,"vm.calculationResult.calculationMainResult.irr",void 0),s.setPropertyX(e,"vm.calculationResult.calculationMainResult.basis",void 0)}e.viewBusy(!0),m.doCalCulate(e,function(t){e.viewBusy(!1)},function(){e.viewBusy(!1)})}function T(){var t=o.vaildRule.ruleList.findWhere(function(t){return e.displayWhen(t.indexList)}).map(function(e){var t=angular.copy(e);return delete t.indexList,t});return!!g(t)||(e.displayWhen([[-1,3]])&&s.setPropertyX(scope,"vm.selectedBond.convertionFactor",void 0),!1)}var h=c("filetimeToDatetime");e.DATE_FORMAT=a,e.DATETIME_FORMAT=n,e.bondTypeButtons=o.bondTypeButtons,e.calTgtTypeButtons=o.calTgtTypeButtons,e.yieldTypeButtons=o.yieldTypeButtons,e.paymentFrequencys=o.paymentFrequencys,e.__defineSetter__("vm",function(t){this.val=t,s.safeApply(e)}),e.__defineGetter__("vm",function(){return this.val});var C=void 0;e.viewBusy=function(a){C||(C=new t({color:"#fff",lines:12,top:"30%"})),e.isViewBusy=a,a?C.spin($("#tfcalculator-tc")[0]):C.stop()},e.displayWhen=function(t){if(!t||t.length<0||!(t instanceof Array))return!1;if(!e.vm||!e.vm.selectedCalTgtType||!e.vm.selectedBondType)return!1;var a=[];a.push(e.calTgtTypeButtons.indexOfItem(function(t){return t.value===e.vm.selectedCalTgtType.value})),a.push(e.bondTypeButtons.indexOfItem(function(t){return t.value===e.vm.selectedBondType.value}));var n=t.containsItem(a);return n||t.forEach(function(e,t){n||(e[0]&&e[0]===-1&&e[1]&&e[1]===-1?n=!0:e[0]&&e[0]===-1?n=a[1]===e[1]:e[1]&&e[1]===-1&&(n=a[0]===e[0]))}),n},e.onActiveButton=function(t,a,n){var o=t||window.event,l=o.target||o.srcElement;l&&"BUTTON"===l.nodeName&&(s.setPropertyX(e,a,angular.element(l).scope().item),n&&e.onChangePropperty&&e.onChangePropperty(a))},e.onChangePropperty=function(t){if(e.vm){console.debug("onChangePropperty: "+t);var a=void 0,n=void 0,o=function(){n=e.vm.calculationResult.calculationMainResult,n.irr||(n.irr=1),e.vm.calculationResult={},e.vm.calculationResult.calculationMainResult=n},l=function(){a=s.getPropertyX(e,"vm.selectedCalTgtType"),a.value===e.calTgtTypeButtons[1].value?o():a.value===e.calTgtTypeButtons[2].value?(delete e.vm.selectedFuture.futurePrice,o()):a.value===e.calTgtTypeButtons[3].value?e.vm.calculationResult={}:e.vm.calculationResult={}};switch(t){case"vm.selectedCalTgtType":if(a=s.getPropertyX(e,t),!a)break;a.value===e.calTgtTypeButtons[0].value?s.setPropertyX(e,"vm.selectedBond.yieldByDay",void 0):a.value===e.calTgtTypeButtons[1].value||(a.value===e.calTgtTypeButtons[2].value?s.setPropertyX(e,"vm.selectedBond.yieldByDay",void 0):a.value===e.calTgtTypeButtons[3].value&&(s.setPropertyX(e,"vm.selectedBond.yieldByDay",void 0),e.vm.selectedBondType=e.bondTypeButtons[0],R()));break;case"vm.selectedYieldType":B();break;case"vm.selectedBondType":var r=s.getPropertyX(e,t);if(!r)break;e&&e.vm&&e.vm.selectedBond&&"VIRTUAL_BOND"===e.vm.selectedBond.bondCode&&(e.vm.selectedBond.bondCode=""),r.value===e.bondTypeButtons[0].value?R():r.value===e.bondTypeButtons[1].value?R():r.value===e.bondTypeButtons[2].value?(delete e.vm.selectedBond.yieldByDay,e.vm.selectedBond=void 0,l()):r.value===e.bondTypeButtons[3].value&&(e.vm.selectedBond||(e.vm.selectedBond={}),delete e.vm.selectedBond.yieldByDay,e.vm.selectedBond.bondCode=e.bondTypeButtons[3].value,e.vm.selectedBond.paymentFrequency||(e.vm.selectedBond.paymentFrequency=e.paymentFrequencys.findItem(function(e){return"A"===e.value})),e.vm.selectedBond.interestStartDate=void 0,e.vm.selectedBond.maturityDate=void 0,e.vm.selectedBond.fixedCoupon=void 0,e.vm.selectedBond["yield"]=void 0,e.vm.selectedBond.netPrice=void 0,e.vm.selectedBond.fullPrice=void 0,e.vm.selectedBond.convertionFactor=void 0,l(),e.searchedBondList=[]);break;default:d.delayOnChangeEvent(function(){if(console.log("onChangePropperty propName:{0}".format(t)),"vm.capitalCost"===t){var a=T();if(!a)return}var n=D(t);!n&&e.displayWhen([[-1,3]])&&s.setPropertyX(e,"vm.selectedBond.convertionFactor",void 0)})}}},e.onKeydownChangedProperty=function(t,a){if(o.bondPriceType.hasOwnProperty(a)){if(!e.vm.selectedBond)return;e.vm.selectedBond.bondPriceType=o.bondPriceType[a]}if(13===t.keyCode){var n=T();if(!n)return void(e.displayWhen([[-1,3]])&&s.setPropertyX(e,"vm.selectedBond.convertionFactor",void 0));var l=D(a);!l&&e.displayWhen([[-1,3]])&&s.setPropertyX(e,"vm.selectedBond.convertionFactor",void 0)}};(function(){e.viewBusy(!0),e.vm={},y()})()}])}),define("tc.headerCtrl",["tc.mainModule"],function(e){"use strict";var t=function(){return{dto:{postFutureInitCalculation:{targetBonds:{},bondPrice:{},bondInfo:{},calculationMainRequest:{},futureContract:{tfId:"selectedFuture.tfId"},capitalCost:"capitalCost"},refreshFuturePrice:{GetFuturePriceRequestDto:{calculationMainRequest:{calculationType:"selectedCalTgtType.value"},targetBonds:"selectedBondType.value",futureContract:{tfId:"selectedFuture.tfId",tfKey:"selectedFuture.tfKey",tradingDate:"selectedFuture.startDate",deliveryDate:"selectedFuture.maturityDate"},capitalCost:"capitalCost",scheduleBondId:"selectedBond.id",bondYield:"selectedBond.yield",bondInfo:{bondKey:"selectedBond.bondKey",listedMarket:"selectedBond.listedMarket",fixedCoupon:"selectedBond.fixedCoupon",paymentFrequency:"selectedBond.paymentFrequency.value",interestStartDate:"selectedBond.interestStartDate",maturityDate:"selectedBond.maturityDate"},fixedCoupon:"selectedBond.fixedCoupon"},BPMainRequestDto:{irr:"calculationResult.calculationMainResult.irr"}},temp:{GetFuturePriceRequestDto:{},BPMainRequestDto:{irr:9.36}}},vaildRule:{refreshFuturePrice:[{prop:"vm.selectedBond",rule:"required",errorMessage:"债券信息不能为空"},{prop:"vm.selectedBond.yield",rule:"required",displayName:"收益率",errorMessage:"请输入收益率"},{prop:"vm.selectedBond.yield",rule:"regexp",displayName:"收益率",errorMessage:"收益率输入错误，正确格式： 00.0000, 最大值100%，最小值-100%",param:{pattern:/^(-?\d{0,2})$|^(-?\d{0,2}.\d{1,4})$/}},{prop:"vm.selectedBond.yield",rule:"rangeOpen",displayName:"收益率",errorMessage:"收益率输入错误，正确格式： 00.0000, 最大值100%，最小值-100%",param:{max:100,min:-100}},{prop:["vm.calculationResult.calculationMainResult.irr","vm.calculationResult.calculationMainResult.basis","vm.calculationResult.calculationMainResult.netBasis"],rule:"requiredAny",errorMessage:"IRR、基差、净基差信息不能全部为空"}]}}}(),a=["$scope","$injector","$state","$location","$filter","commonService","httpService","tcService","servicePathConst",function(e,a,n,o,l,r,i,c,u){function s(){e.viewBusy(!0),e.vm.selectedBondType=e.bondTypeButtons[0],c.changeFuture(e,function(){e.viewBusy(!1)},function(){e.viewBusy(!1)})}e.getDateDiff=function(t,a,n){return t&&"Date"===t.constructor.name&&(t=t.formatDate(e.DATE_FORMAT)),a&&"Date"===a.constructor.name&&(a=a.formatDate(e.DATE_FORMAT)),r.getDateDiff(t,a,n)},e.isWarnDatetime=function(t){return r.getDateDiff(t,(new Date).formatDate(e.DATE_FORMAT),"minute")>=60},e.onChangeFuture=function(){if(e.originFutures){var t=e.originFutures.findItem(function(t){return t.tfKey===e.vm.selectedFuture.tfKey});t&&(e.vm.selectedFuture.maturityDate=t.maturityDate,e.vm.selectedFuture.startDate=t.startDate)}s()},e.resetViewModel=function(t){function a(){e.vm.selectedFuture&&e.originVM.selectedFuture&&angular.merge(e.vm.selectedFuture,angular.copy(e.originVM.selectedFuture))}function n(){e.vm.selectedBond&&e.originVM.selectedBond&&(delete e.originVM.selectedBond.paymentFrequency,angular.merge(e.vm.selectedBond,angular.copy(e.originVM.selectedBond)))}if(!e.originVM)return void location.reload();if(e.vm&&e.vm.selectedCalTgtType){if(e.originVM.futures&&e.originVM.futures.length>0&&e.originVM.futures instanceof Array&&e.vm.selectedFuture){var o=e.originVM.futures.findItem(function(t){
return t.tfKey===e.vm.selectedFuture.tfKey});o&&angular.merge(e.vm.selectedFuture,o)}switch(e.vm.selectedCalTgtType.value){case"IRR_BASE":a(),n();break;case"BOND_PRICE":a(),n();break;case"FUTURE_THEORETICAL_PRICE":a(),n();break;case"FUTURE_ANALYSIS":a(),n()}if(e.vm.selectedBondType)switch(e.vm.selectedBondType.value){case"DELIVABLE_BONDS":break;case"SCHEDULED_BONDS":break;case"SELECTED_BOND":break;case"VIRTUAL_BOND":return void["vm.selectedBond.interestStartDate","vm.selectedBond.maturityDate","vm.selectedBond.fixedCoupon","vm.selectedBond.convertionFactor","vm.selectedBond.yield","vm.selectedBond.netPrice","vm.selectedBond.fullPrice","vm.selectedBond.yieldByDay"].forEach(function(t){r.setPropertyX(e,t,void 0)})}e.vm.selectedYieldType||(e.vm.selectedYieldType=e.yieldTypeButtons[0]),r.setPropertyX(e,"vm.calculationResult.calculationMainResult",angular.copy(r.getPropertyX(e,"originVM.calculationResult.calculationMainResult"))),e.viewBusy(!0),c.doCalCulate(e,function(){e.viewBusy(!1)},function(){e.viewBusy(!1)})}},e.onClickRefreshFuturePrice=function(a){if(e.vm&&r.checkViewModel(e,t.vaildRule.refreshFuturePrice)){e.viewBusy(!0);var n=r.getDto(e.vm,t.dto.refreshFuturePrice,e.DATE_FORMAT);i.postService(u.tc_post_get_future_price,n,function(t){e.viewBusy(!1),angular.merge(e.vm.calculationResult,t),e.vm.selectedFuture||(e.vm.selectedFuture={}),e.vm.selectedFuture.futurePrice=t.futurePrice,e.vm.selectedFuture.lastUpdateDatetime=t.lastFutureUpdateDate,e.displayWhen&&e.displayWhen([[1,2]])&&e.onChangeBond&&e.onChangeBond()},function(t){e.viewBusy(!1),r.commonErrorDialog(e,t,"获取最新期货价格失败")})}}}];e.controller("tc.headerCtrl",["$scope","$injector","$sce","$location","$filter","commonService","tcService",function(e,t,n,o,l,r,i){t.invoke(a,this,{$scope:e.$parent,$sce:n,$location:o,$filter:l,commonService:r,tcService:i})}])}),define("tc.tabViewCtrl",["tc.mainModule"],function(e){"use strict";var t=function(){return{dto:{changeBond:{bondChangedRequestDto:{futureContract:{tfId:"selectedFuture.tfId",tradingDate:"selectedFuture.startDate",deliveryDate:"selectedFuture.maturityDate"},capitalCost:"capitalCost",bondKey:"selectedBond.bondKey",listedMarket:"selectedBond.listedMarket",bondId:"selectedBond.id",targetBonds:"selectedBondType.value",calculationMainRequest:{calculationType:"selectedCalTgtType.value"}},IRRMainRequestDto:{futurePrice:"selectedFuture.futurePrice"}},changeBond_bondPrice:{BPMainRequestDto:{futurePrice:"selectedFuture.futurePrice",irr:"calculationResult.calculationMainResult.irr",basis:"calculationResult.calculationMainResult.basis",netBasis:"calculationResult.calculationMainResult.netBasis"}},changeBond_futureAnalysis:{FSAMainRequestDto:{irr:"calculationResult.calculationMainResult.irr",basis:"calculationResult.calculationMainResult.basis",netBasis:"calculationResult.calculationMainResult.netBasis"}}}}}(),a=["$scope","$injector","$state","$location","$filter","httpService","commonService","tcService","servicePathConst",function(e,a,n,o,l,r,i,c,u){e.onClickSaveResult=function(t){if(e.resultList||(e.resultList=[]),100===e.resultList.length)return void i.commonErrorDialog(e,void 0,"计算结果不能超过100条，请删除后再保存。");var a=angular.copy(e.vm);if(a.selectedBondType)switch(a.selectedBondType.value){case e.bondTypeButtons[0].value:break;case e.bondTypeButtons[1].value:a.selectedBond&&a.selectedBond.issueStartDate&&(a.selectedBond.bondCode=e.bondTypeButtons[1].display+a.selectedBond.issueStartDate.formatDate("yy/MM"));break;case e.bondTypeButtons[2].value:break;case e.bondTypeButtons[3].value:}console.debug(a),a.addedDatetime=new Date,a&&a.selectedFuture&&("Date"===a.selectedFuture.startDate.constructor.name&&(a.selectedFuture.startDate=a.selectedFuture.startDate.formatDate(e.DATE_FORMAT)),"Date"===a.selectedFuture.maturityDate.constructor.name&&(a.selectedFuture.maturityDate=a.selectedFuture.maturityDate.formatDate(e.DATE_FORMAT))),e.resultList.push(a)},e.onChangeBond=function(a){if(e.vm&&(a&&(e.vm.selectedBond=a),e.vm.selectedBond)){var n=i.getDto(e.vm,t.dto.changeBond,e.DATE_FORMAT);e.vm&&e.vm.selectedCalTgtType&&(e.vm.selectedCalTgtType.value===e.calTgtTypeButtons[1].value?angular.merge(n,i.getDto(e.vm,t.dto.changeBond_bondPrice,e.DATE_FORMAT)):e.vm.selectedCalTgtType.value!==e.calTgtTypeButtons[2].value&&e.vm.selectedCalTgtType.value!==e.calTgtTypeButtons[3].value||(angular.merge(n,i.getDto(e.vm,t.dto.changeBond_futureAnalysis,e.DATE_FORMAT)),delete n.IRRMainRequestDto)),e.viewBusy(!0),r.postService(u.tc_post_bond_changed,n,function(t){if(e.viewBusy(!1),!t)return void i.commonErrorDialog(e,void 0,"获取所选债券数据失败");e.vm.calculationResult||(e.vm.calculationResult={}),angular.merge(e.vm.calculationResult,t),angular.merge(e.vm.selectedBond,t.bondPrice),angular.merge(e.vm.selectedBond,t.calculationMainResult),e.vm.selectedYieldType=e.yieldTypeButtons.findItem(function(t){return t.value===e.vm.selectedBond.yieldType});var a=i.getPropertyX(t,"calculationMainResult.futurePrice");a&&i.setPropertyX(e,"vm.selectedFuture.futurePrice",a),t.bondConvertionFactor&&(e.vm.selectedBond.convertionFactor=t.bondConvertionFactor),e.originVM=angular.copy(e.vm)},function(t){e.viewBusy(!1),e.displayWhen&&e.displayWhen([[1,2]])||i.commonErrorDialog(e,t,"获取所选债券数据失败")})}},e.onChangeBondForSearch=function(t){console.debug("onChangeBondForSearch"),t&&t.newValue&&e.onChangeBond(t.newValue)},e.onChangeBondSearchKeyword=function(t,a){a&&a.newValue&&4===a.newValue.length&&(console.debug("onChangeBondSearchKeyword"),e.viewBusy(!0),r.postService(u.tc_post_find_fix_interest_bonds,a.newValue,function(t){t&&!(t.length<0)&&t instanceof Array&&(t.forEach(function(t,a){t.paymentFrequency=angular.copy(e.paymentFrequencys.findItem(function(e){return e.value===t.paymentFrequency}))}),e.searchedBondList=t,setTimeout(function(){a.target.focus()},500),e.viewBusy(!1))},function(t){e.viewBusy(!1)}))},e.selectedBondListFormatter=function(e){return"{0}    {1}".format(e.bondCode,e.shortName)}}];e.controller("tc.tabViewCtrl",["$scope","$injector","$sce","$location","$filter","commonService","tcService",function(e,t,n,o,l,r,i){t.invoke(a,this,{$scope:e.$parent,$sce:n,$location:o,$filter:l,commonService:r,tcService:i})}])}),define("tc.resultListCtrl",["tc.mainModule"],function(e){"use strict";var t=function(){return{dto:{exportExcel:{tfID:"selectedFuture.tfId",bondCode:"selectedBond.bondCode",futurePrice:"selectedFuture.futurePrice",bondRate:"selectedBond.yield",bondRateByAddDay:"selectedBond.yieldByDay",bondNetPrice:"selectedBond.netPrice",convertionFactor:"selectedBond.convertionFactor",irr:"calculationResult.calculationMainResult.irr",basis:"calculationResult.calculationMainResult.basis",netBasis:"calculationResult.calculationMainResult.netBasis",trialTime:"addedDatetime",tradingDate:"selectedFuture.startDate",deliveryDate:"selectedFuture.maturityDate",capitalCost:"capitalCost",bondFullPrice:"selectedBond.fullPrice",carry:"calculationResult.carry",receiptPrice:"calculationResult.receiptPrice",futureSpotSpread:"calculationResult.futureSpotSpread",interestsRateSpread:"calculationResult.interestsRateSpread",interestOnSettlementDate:"calculationResult.interestOnSettlementDate",interestOnTradingDate:"calculationResult.interestOnTradingDate",interestDuringHolding:"calculationResult.interestDuringHolding",weightedAverageInterest:"calculationResult.weightedAverageInterest"}}}}(),a=["$scope","$injector","$state","$location","$filter","$http","httpService","commonService","tcService","servicePathConst",function(e,a,n,o,l,r,i,c,u,s){e.onChangeResultListSelectedAll=function(){e.resultList&&!(e.resultList.length<=0)&&e.resultList instanceof Array&&e.resultList.forEach(function(t,a){t.isSelected=e.vm.isResultListSelectedAll})},e.onClickResultListDeleteItem=function(t){if(e.resultList&&0!==e.resultList.length&&e.resultList instanceof Array){var a=e.resultList.findWhere(function(e,t){return e.isSelected});if(!(a&&0!==a.length&&a instanceof Array))return void c.commonErrorDialog(e,void 0,"请勾选至少一条记录再執行刪除。");e.resultList=e.resultList.findWhere(function(e,t){return!e.isSelected}),e.vm.isResultListSelectedAll=!1}},e.onClickExportExcel=function(a){if(!e.resultList||e.resultList.length<=0||!(e.resultList instanceof Array))return void c.commonErrorDialog(e,void 0,"列表中没有保存的计算结果");var n=e.resultList.findWhere(function(e){return e.isSelected});if(!n||n.length<=0||!(n instanceof Array))return void c.commonErrorDialog(e,void 0,"请勾选至少一条记录再导出。");var o=n.map(function(a){var n=angular.copy(t.dto.exportExcel),o=c.getDto(a,n);return o&&o.trialTime&&"Date"===o.trialTime.constructor.name&&(o.trialTime=o.trialTime.formatDate(e.DATETIME_FORMAT)),o}).findWhere(function(e){return void 0!==e});e.viewBusy(!0);var l=s.service_api_root?s.service_api_root+s.tc_post_excel_export:s.tc_post_excel_export;r({url:l,method:"post",responseType:"arraybuffer",data:JSON.stringify(o)}).success(function(t,a,n){if(e.viewBusy(!1),200!==a)return void c.commonErrorDialog(e,void 0,"导出Excel文件失败");var o=new Blob([t],{type:"application/vnd.ms-excel;charset=UTF-8"},(!0));saveAs(o,"TF计算器{0}.xls".format((new Date).formatDate("yyyyMMdd"))),c.commonErrorDialog(e,void 0,"导出Excel文件成功，请于下载文件夹下查看。")}).error(function(t,a){e.viewBusy(!1),c.commonErrorDialog(e,void 0,"导出Excel文件失败")})}}];e.controller("tc.resultListCtrl",["$scope","$injector","$sce","$location","$filter","commonService","tcService",function(e,t,n,o,l,r,i){t.invoke(a,this,{$scope:e.$parent,$sce:n,$location:o,$filter:l,commonService:r,tcService:i})}])}),require.config({baseUrl:".",paths:{spin:"common/scripts/spin","tc.mainModule":"tf_calculator/mainModule",tcService:"tf_calculator/tcService","tc.mainCtrl":"tf_calculator/controllers/mainCtrl","tc.headerCtrl":"tf_calculator/controllers/headerCtrl","tc.tabViewCtrl":"tf_calculator/controllers/tabViewCtrl","tc.resultListCtrl":"tf_calculator/controllers/resultListCtrl"},shim:{}}),define("tf_calculator/main",["tc.mainModule","tcService","tc.mainCtrl","tc.headerCtrl","tc.tabViewCtrl","tc.resultListCtrl"],function(e){"use strict";return e.run(["$rootScope","$urlRouter",function(e,t){e.$on("$locationChangeSuccess",function(e){e.preventDefault(),t.sync()})}]),e});